;; =================================================================== ;;
;; Скрипт для вимірювання ширини між двома точками.                    ;;
;; Оновлена версія з короткою командою та гарантованою крапкою.       ;;
;; Команда для запуску: WW                                               ;;
;; =================================================================== ;;

(defun c:WW (/ p1 p2 dist dist_text text_p)
  ; Повідомлення про початок роботи
  (princ "\nЗапуск скрипту вимірювання ширини. Натисніть ESC для виходу.")

  ; Встановлюємо стиль тексту "Д-431", якщо він не існує.
  ; Ви можете змінити "romans.shx" на потрібний вам файл шрифту.
  (if (not (tblsearch "STYLE" "Д-431"))
    (command "_.-STYLE" "Д-431" "romans.shx" "0" "1" "0" "N" "N")
  )

  ; Починаємо цикл, який буде повторюватись, поки користувач не натисне Esc
  (while
    (progn
      ; Запит першої точки. Програма зупиниться, якщо тут натиснути Esc.
      (setq p1 (getpoint "\nВкажіть першу точку: "))
      ; Якщо перша точка вказана, запитуємо другу. 'p1' вказує на початок гумової нитки.
      (if p1
        (setq p2 (getpoint p1 "\nВкажіть другу точку: "))
      )
    ) ; progn завершено

    ; Продовжуємо, тільки якщо обидві точки були вказані
    (if (and p1 p2)
      (progn
        ; 1. Обчислюємо відстань між точками
        (setq dist (distance p1 p2))

        ; 2. Форматуємо текст для виводу (2 знаки після коми)
        (setq dist_text (rtos dist 2 2))
        
        ; 3. ГАРАНТУЄМО, що розділювач - крапка (замінюємо кому на крапку)
        (setq dist_text (vl-string-subst "." "," dist_text))

        ; 4. Запитуємо точку для вставки тексту
        (setq text_p (getpoint "\nВкажіть місце для тексту результату: "))

        ; 5. Якщо точка вставки вказана, створюємо текст
        (if text_p
          (progn
            ; Створюємо текстовий об'єкт за допомогою команди AutoCAD
            (command "_.-TEXT"          ; Виклик текстової команди
                     "_STYLE" "Д-431"   ; Встановлення стилю тексту
                     "_Justify" "MC"    ; Вирівнювання по центру (Middle Center) для зручності
                     text_p             ; Точка вставки
                     1.0                ; Висота тексту
                     0                  ; Кут повороту
                     dist_text          ; Сам текст (результат виміру)
            )
            ; Змінюємо колір останнього створеного об'єкта на синій
            (entmod (list (cons -1 (entlast)) (cons 62 5))) ; 62 - код кольору, 5 - синій
          ) ; progn для створення тексту
        ) ; if text_p
      ) ; progn основного блоку
    ) ; if (and p1 p2)
  ) ; while

  (princ) ; Тихе завершення команди без виводу nil в консоль
)

; Повідомлення про успішне завантаження скрипту
(princ "\nСкрипт завантажено. Введіть команду WW для запуску.")
(princ)
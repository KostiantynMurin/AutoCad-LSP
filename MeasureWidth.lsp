;; =================================================================== ;;
;; Скрипт для вимірювання ширини між двома точками.                    ;;
;; Версія 3: Використовує (entmake) для створення тексту.             ;;
;; Команда для запуску: WW                                               ;;
;; =================================================================== ;;

(defun c:WW ( / p1 p2 dist dist_text text_p text-style text-height text-color text-angle cur-layer)
  
  ;; --- Налаштування параметрів тексту ---
  (setq text-style  "Д-431" ; Назва стилю
        text-height 1.0     ; Висота тексту
        text-color  5       ; Колір (5 = Синій/Blue)
        text-angle  0.0     ; Кут повороту
  )
  
  ; Повідомлення про початок роботи
  (princ "\nЗапуск скрипту вимірювання ширини. Натисніть ESC для виходу.")

  ; Встановлюємо стиль тексту "Д-431", якщо він не існує.
  (if (not (tblsearch "STYLE" text-style))
    (command "_.-STYLE" text-style "romans.shx" "0" "1" "0" "N" "N")
  )

  ; Починаємо цикл, який буде повторюватись, поки користувач не натисне Esc
  (while
    (progn
      (setq p1 (getpoint "\nВкажіть першу точку: "))
      (if p1 (setq p2 (getpoint p1 "\nВкажіть другу точку: ")))
    )

    ; Продовжуємо, тільки якщо обидві точки були вказані
    (if (and p1 p2)
      (progn
        (setq dist (distance p1 p2))
        (setq dist_text (rtos dist 2 2))
        (setq dist_text (vl-string-subst "." "," dist_text)) ; Гарантуємо крапку
        
        (setq text_p (getpoint "\nВкажіть місце для тексту результату: "))

        ; Якщо точка вставки вказана, створюємо текст
        (if text_p
          (progn
            (setq cur-layer (getvar "CLAYER")) ; Отримуємо ім'я поточного шару

            ;; -- СТВОРЕННЯ ТЕКСТУ МЕТОДОМ (ENTMAKE) --
            ;; Цей метод створює об'єкт напряму, без використання командного рядка
            (entmake
              (list
                '(0 . "TEXT")                     ; Тип об'єкта: Текст
                (cons 1 dist_text)               ; Вміст тексту (результат виміру)
                (cons 10 text_p)                 ; Точка вставки (DXF-код 10)
                (cons 40 text-height)            ; Висота тексту (DXF-код 40)
                (cons 50 text-angle)             ; Кут повороту (DXF-код 50)
                (cons 7 text-style)              ; Стиль тексту (DXF-код 7)
                (cons 8 cur-layer)               ; Шар (DXF-код 8)
                (cons 62 text-color)             ; Колір (DXF-код 62)
                '(72 . 4)                         ; Вирівнювання по горизонталі: 4 = Middle
                '(73 . 2)                         ; Вирівнювання по вертикалі: 2 = Middle
              )
            )
            (princ (strcat "\nСтворено текст: \"" dist_text "\"."))
          )
        )
      )
    )
  )
  (princ) ; Тихе завершення команди
)

; Повідомлення про успішне завантаження скрипту
(princ "\nСкрипт 'WW' (v3) завантажено. Введіть команду WW для запуску.")
(princ)
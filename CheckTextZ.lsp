;;;------------------------------------------------------------------------------;;;
;;; –ö–æ–º–∞–Ω–¥–∞: CheckTextZ                                                        ;;;
;;; –û–ø–∏—Å: –ü–µ—Ä–µ–≤—ñ—Ä—è—î Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –æ–±—Ä–∞–Ω–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –æ–±'—î–∫—Ç—ñ–≤ (TEXT, MTEXT).      ;;;
;;; –ü–æ—Ä—ñ–≤–Ω—é—î —Ñ–∞–∫—Ç–∏—á–Ω—É Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É –∑ —á–∏—Å–ª–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º, –≤–∫–∞–∑–∞–Ω–∏–º —É —Å–∞–º–æ–º—É      ;;;
;;; —Ç–µ–∫—Å—Ç—ñ. –Ø–∫—â–æ —î —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å, –ø—Ä–æ–ø–æ–Ω—É—î –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–ª–æ–∂–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤.         ;;;
;;;------------------------------------------------------------------------------;;;
(defun  (/ *error* ss i ent edata pt z_actual text_content z_from_text tolerance mismatch_list response moved_count)

  ;; –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω–µ ESC)
  (defun *error* (msg)
    (if (not (member msg '("Function cancelled" "quit / exit abort")))
      (princ (strcat "\n–ü–æ–º–∏–ª–∫–∞: " msg))
    )
    (princ) ; "—Ç–∏—Ö–µ" –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
  )

  ;; --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---
  (setq tolerance 0.5) ; –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –¥–æ–ø—É—Å–∫. –Ø–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è Z –±—ñ–ª—å—à–∞ –∑–∞ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è, –æ–±'—î–∫—Ç –≤–≤–∞–∂–∞—î—Ç—å—Å—è –Ω–µ–≤—ñ—Ä–Ω–∏–º.

  (princ "\n–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ñ –æ–±'—î–∫—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ üßê: ")
  
  ;; –§—ñ–ª—å—Ç—Ä—É—î–º–æ –≤–∏–±—ñ—Ä, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º—ñ–≥ –æ–±—Ä–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ TEXT —Ç–∞ MTEXT
  (setq ss (ssget '((0 . "TEXT,MTEXT"))))

  (if ss
    (progn
      (setq i 0)
      (setq mismatch_list '()) ; –°—Ç–≤–æ—Ä—é—î–º–æ –ø—É—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö" –æ–±'—î–∫—Ç—ñ–≤
      
      ;; –ü–æ—á–∏–Ω–∞—î–º–æ —Ü–∏–∫–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –æ–±—Ä–∞–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞
      (repeat (sslength ss)
        (setq ent (ssname ss i))     ; –û—Ç—Ä–∏–º—É—î–º–æ —ñ–º'—è –æ–±'—î–∫—Ç–∞
        (setq edata (entget ent))    ; –û—Ç—Ä–∏–º—É—î–º–æ –π–æ–≥–æ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ (DXF-–∫–æ–¥–∏)
        
        (setq pt (cdr (assoc 10 edata)))         ; –¢–æ—á–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ (X Y Z)
        (setq z_actual (caddr pt))              ; –§–∞–∫—Ç–∏—á–Ω–∞ Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
        
        (setq text_content (cdr (assoc 1 edata))) ; –í–º—ñ—Å—Ç —Ç–µ–∫—Å—Ç—É (–π–æ–≥–æ "—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ")
        (setq z_from_text (atof text_content))    ; –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –≤ —á–∏—Å–ª–æ
        
        ;; –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω—É Z –∑ Z —ñ–∑ —Ç–µ–∫—Å—Ç—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –¥–æ–ø—É—Å–∫—É
        (if (> (abs (- z_actual z_from_text)) tolerance)
          ;; –Ø–∫—â–æ —î —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å, –¥–æ–¥–∞—î–º–æ –æ–±'—î–∫—Ç –¥–æ —Å–ø–∏—Å–∫—É –Ω–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
          (setq mismatch_list (cons ent mismatch_list))
        )
        (setq i (1+ i)) ; –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞
      )
      
      ;; –ü—ñ—Å–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—Å—ñ—Ö –æ–±'—î–∫—Ç—ñ–≤ –∞–Ω–∞–ª—ñ–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (if mismatch_list
        (progn
          ;; –Ø–∫—â–æ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π, –∑–∞–ø–∏—Ç—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
          (initget "–¢–∞–∫ –ù—ñ") ; –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
          (setq response
                 (getkword
                   (strcat
                     "\n‚ùó –ó–Ω–∞–π–¥–µ–Ω–æ "
                     (itoa (length mismatch_list))
                     " –æ–±'—î–∫—Ç—ñ–≤ –∑ –Ω–µ–≤—ñ—Ä–Ω–æ—é Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—é. –ó–º—ñ–Ω–∏—Ç–∏ —ó—Ö –ø–æ–ª–æ–∂–µ–Ω–Ω—è? [–¢–∞–∫/–ù—ñ] <–¢–∞–∫>: "
                   )
                 )
          )
          
          ;; –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å "–¢–∞–∫" –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ç–∏—Å–Ω—É–≤ Enter (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º "–¢–∞–∫")
          (if (or (not response) (= response "–¢–∞–∫"))
            (progn
              (setq moved_count 0)
              ;; –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É
              (foreach entity mismatch_list
                (setq edata (entget entity))
                (setq pt (cdr (assoc 10 edata)))
                (setq text_content (cdr (assoc 1 edata)))
                (setq z_from_text (atof text_content))
                
                ;; –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É —Ç–æ—á–∫—É –≤—Å—Ç–∞–≤–∫–∏ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—é
                (setq new_pt (list (car pt) (cadr pt) z_from_text))
                
                ;; –ó–∞–º—ñ–Ω—é—î–º–æ —Å—Ç–∞—Ä—É —Ç–æ—á–∫—É –≤—Å—Ç–∞–≤–∫–∏ (DXF-–∫–æ–¥ 10) –Ω–∞ –Ω–æ–≤—É
                (setq edata (subst (cons 10 new_pt) (assoc 10 edata) edata))
                
                ;; –û–Ω–æ–≤–ª—é—î–º–æ –æ–±'—î–∫—Ç –≤ –∫—Ä–µ—Å–ª–µ–Ω–Ω—ñ
                (entmod edata)
                (setq moved_count (1+ moved_count))
              )
              (princ (strcat "\n‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–º—ñ–Ω–µ–Ω–æ –ø–æ–ª–æ–∂–µ–Ω–Ω—è –¥–ª—è " (itoa moved_count) " –æ–±'—î–∫—Ç—ñ–≤. "))
            )
            (princ "\n–î–æ–±—Ä–µ, –∂–æ–¥–Ω–∏—Ö –∑–º—ñ–Ω –Ω–µ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ. üòâ")
          )
        )
        (princ "\n‚úÖ –ß—É–¥–æ–≤–æ! –£—Å—ñ –æ–±—Ä–∞–Ω—ñ –æ–±'—î–∫—Ç–∏ –º–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É Z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É.")
      )
    )
    (princ "\n–ù–µ –æ–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑. üòä")
  )
  (princ) ; "–ß–∏—Å—Ç–µ" –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ –±–µ–∑ –≤–∏–≤–æ–¥—É nil
)